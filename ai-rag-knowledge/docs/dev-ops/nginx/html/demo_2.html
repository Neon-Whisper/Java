<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>AIåŠ©æ‰‹å¯¹è¯</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-animation{animation:fadeIn .3s ease-in-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .streaming-cursor::after{content:'â–‹';animation:blink 1s infinite}
        @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
        .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .glass-effect{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18)}
        .message-bubble-user{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,.3)}
        .message-bubble-ai{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);color:#1e293b;box-shadow:0 4px 15px rgba(148,163,184,.2)}
        .input-glow{box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        .input-glow:focus{box-shadow:0 0 0 3px rgba(102,126,234,.2)}
        .send-button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);transition:all .3s ease}
        .send-button:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
        .send-button:active{transform:translateY(0)}
        .typing-indicator{display:none;padding:12px 20px;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:18px;margin-bottom:16px;width:fit-content;box-shadow:0 4px 15px rgba(148,163,184,.1)}
        .typing-indicator span{display:inline-block;width:8px;height:8px;border-radius:50%;background:#667eea;margin:0 2px;animation:typing 1.4s infinite ease-in-out}
        .typing-indicator span:nth-child(1){animation-delay:-.32s}
        .typing-indicator span:nth-child(2){animation-delay:-.16s}
        @keyframes typing{0%,80%,100%{transform:scale(.8);opacity:.5}40%{transform:scale(1);opacity:1}}
        .header-glow{text-shadow:0 2px 4px rgba(0,0,0,.1)}
        .scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}
        .scrollbar-hide::-webkit-scrollbar{display:none}

        /* ---- å·¦ä¾§ä¼šè¯åˆ—è¡¨ ---- */
        .chat-list-item{transition:background .2s}
        .chat-list-item:hover{background:rgba(102,126,234,.08)}
        .chat-list-item.active{background:rgba(102,126,234,.15);color:#4f46e5;font-weight:600}
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen flex">

<!-- ========= å·¦ä¾§ä¼šè¯åˆ—è¡¨ ========= -->
<aside class="w-64 bg-white/80 backdrop-blur border-r border-gray-200 flex flex-col">
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="font-bold text-gray-700">ä¼šè¯åˆ—è¡¨</h2>
        <button id="newChat" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">æ–°å»ºèŠå¤©</button>
    </div>
    <ul id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-hide"></ul>
</aside>

<!-- ========= å³ä¾§å¯¹è¯åŒº ========= -->
<section class="flex-1 flex flex-col">
    <div class="container mx-auto max-w-4xl h-screen flex flex-col p-4">
        <!-- å¤´éƒ¨ -->
        <header class="gradient-bg text-white p-6 rounded-t-3xl shadow-2xl flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold header-glow">ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h1>
                <p class="text-purple-100 mt-2">åŸºäº qwen2.5 æ¨¡å‹ Â· æµå¼å¯¹è¯</p>
            </div>
            <div id="chatOps" class="hidden items-center space-x-2">
                <button id="renameBtn" class="px-3 py-1 bg-white/20 rounded-lg hover:bg-white/30">é‡å‘½å</button>
                <button id="deleteBtn" class="px-3 py-1 bg-white/20 rounded-lg hover:bg-red-400">åˆ é™¤</button>
            </div>
        </header>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <main class="flex-1 glass-effect rounded-b-3xl shadow-xl overflow-hidden">
            <div id="chatContainer" class="h-full flex flex-col">
                <div id="messagesList" class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide">
                    <!-- é»˜è®¤æ¬¢è¿è¯­ -->
                    <div class="message-animation flex justify-start">
                        <div class="message-bubble-ai rounded-2xl px-6 py-4 max-w-3xl">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">AI</div>
                                <div>
                                    <p class="font-semibold text-purple-700 mb-1">AIåŠ©æ‰‹</p>
                                    <p class="text-gray-700">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
                <div id="typingIndicator" class="typing-indicator message-animation"><span></span><span></span><span></span></div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="p-6 border-t border-gray-100 bg-gradient-to-r from-white to-gray-50">
                    <form id="chatForm" class="flex space-x-4">
                        <input id="messageInput" type="text" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." autocomplete="off"
                               class="flex-1 px-6 py-4 border border-gray-200 rounded-2xl focus:outline-none input-glow transition-all duration-300 text-gray-700 placeholder-gray-400">
                        <button id="sendButton" type="submit" class="send-button text-white px-8 py-4 rounded-2xl font-semibold flex items-center space-x-2 shadow-lg">
                            <span>å‘é€</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        </button>
                    </form>
                    <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
                        <span>ğŸ’¡ æç¤ºï¼šæ”¯æŒæµå¼å®æ—¶å¯¹è¯</span>
                        <span class="text-purple-600 font-medium">æ¨¡å‹: qwen2.5:7b</span>
                    </div>
                </div>
            </div>
        </main>
    </div>
</section>

<script>
    /* ================= æ•°æ®å±‚ ================= */
    const API_BASE = 'http://localhost:8090/api/v1/ollama';
    const MODEL    = 'qwen2.5:7b';

    let chats = JSON.parse(localStorage.getItem('chats')||'[]'); // {id,name,messages:[{role,content}]}
    let activeId = localStorage.getItem('activeChat')||null;

    let sse = null;
    let aiEl= null;
    let streaming = false;

    const $  = q=>document.querySelector(q);
    const listBox  = $('#chatList');
    const msgBox   = $('#messagesList');
    const input    = $('#messageInput');
    const sendBtn  = $('#sendButton');
    const form     = $('#chatForm');
    const indicator= $('#typingIndicator');
    const opsBox   = $('#chatOps');

    /* ================= è§†å›¾å±‚ ================= */
    function save(){
        localStorage.setItem('chats',JSON.stringify(chats));
        localStorage.setItem('activeChat',activeId||'');
    }
    function find(id){return chats.find(c=>c.id===id);}
    function randId(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}

    function renderList(){
        listBox.innerHTML='';
        chats.forEach(c=>{
            const li=document.createElement('li');
            li.className='chat-list-item px-3 py-2 rounded-lg cursor-pointer';
            li.innerHTML=`<span>${c.name}</span>`;
            if(c.id===activeId) li.classList.add('active');
            li.onclick=()=>selectChat(c.id);
            listBox.appendChild(li);
        });
    }
    function selectChat(id){
        activeId=id;
        renderList();
        renderMessages();
        opsBox.classList.toggle('hidden',!id);
    }
    function renderMessages(){
        msgBox.innerHTML='';
        if(!activeId){
            // æ¬¢è¿è¯­
            msgBox.innerHTML=`
      <div class="message-animation flex justify-start">
        <div class="message-bubble-ai rounded-2xl px-6 py-4 max-w-3xl">
          <div class="flex items-start space-x-3">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">AI</div>
            <div>
              <p class="font-semibold text-purple-700 mb-1">AIåŠ©æ‰‹</p>
              <p class="text-gray-700">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</p>
            </div>
          </div>
        </div>
      </div>`;
            return;
        }
        const chat=find(activeId);
        chat.messages.forEach(m=>addMsgEl(m.role,m.content));
        msgBox.scrollTop=msgBox.scrollHeight;
    }
    function addMsgEl(role,content){
        const div=document.createElement('div');
        div.className=`message-animation flex ${role==='user'?'justify-end':'justify-start'}`;
        div.innerHTML=`
    <div class="${role==='user'?'message-bubble-user':'message-bubble-ai'} rounded-2xl px-6 py-4 max-w-3xl">
      <div class="flex items-start space-x-3">
        ${role==='user'?`
          <div>
            <p class="font-semibold text-white/90 mb-1">ä½ </p>
            <p class="text-white">${escapeHTML(content)}</p>
          </div>
          <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
          </div>`:`
          <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">AI</div>
          <div>
            <p class="font-semibold text-purple-700 mb-1">AIåŠ©æ‰‹</p>
            <p class="text-gray-700">${escapeHTML(content)}</p>
          </div>`}
      </div>
    </div>`;
        msgBox.appendChild(div);
        msgBox.scrollTop=msgBox.scrollHeight;
    }
    function escapeHTML(str){
        return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ================= æ–°å»º/é‡å‘½å/åˆ é™¤ ================= */
    $('#newChat').onclick=()=>{
        const name='æ–°ä¼šè¯ '+new Date().toLocaleTimeString();
        const id=randId();
        chats.unshift({id,name,messages:[]});
        save();
        renderList();
        selectChat(id);
    };
    $('#renameBtn').onclick=()=>{
        const chat=find(activeId);
        const n=prompt('æ–°åç§°',chat.name);
        if(n){chat.name=n;save();renderList();}
    };
    $('#deleteBtn').onclick=()=>{
        if(!confirm('ç¡®å®šåˆ é™¤å½“å‰ä¼šè¯ï¼Ÿ')) return;
        chats=chats.filter(c=>c.id!==activeId);
        activeId=null;
        save();
        renderList();
        renderMessages();
    };

    /* ================= å‘é€&æµå¼æ¥æ”¶ ================= */
    function addMessage(role,content){
        const chat=find(activeId);
        chat.messages.push({role,content});
        save();
    }
    function send(){
        const txt=input.value.trim();
        if(!txt||!activeId||streaming) return;
        input.value='';
        addMessage('user',txt);
        addMsgEl('user',txt);

        // AIå ä½
        const div=document.createElement('div');
        div.className='message-animation flex justify-start';
        const aiId='ai'+randId();
        div.innerHTML=`
    <div class="message-bubble-ai rounded-2xl px-6 py-4 max-w-3xl">
      <div class="flex items-start space-x-3">
        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">AI</div>
        <div>
          <p class="font-semibold text-purple-700 mb-1">AIåŠ©æ‰‹</p>
          <p id="${aiId}" class="text-gray-700 streaming-cursor"></p>
        </div>
      </div>
    </div>`;
        msgBox.appendChild(div);
        msgBox.scrollTop=msgBox.scrollHeight;
        aiEl=document.getElementById(aiId);

        streaming=true;
        sendBtn.disabled=true;
        indicator.style.display='block';

        const apiUrl=`${API_BASE}/generate_stream?model=${MODEL}&message=${encodeURIComponent(txt)}`;
        sse=new EventSource(apiUrl);
        let buffer='';

        sse.onmessage=e=>{
            try{
                const arr=JSON.parse(e.data);
                const chunk=arr[0]?.result?.output?.content||'';
                buffer+=chunk;
                aiEl.textContent=buffer;
                msgBox.scrollTop=msgBox.scrollHeight;
                if(arr[0]?.result?.metadata?.finishReason==='STOP') stopStream();
            }catch{}
        };
        sse.onerror=()=>stopStream(true);
    }
    function stopStream(err){
        if(sse){sse.close();sse=null;}
        streaming=false;sendBtn.disabled=false;
        indicator.style.display='none';
        if(aiEl) aiEl.classList.remove('streaming-cursor');
        if(!err&&aiEl) addMessage('assistant',aiEl.textContent);
        if(err&&aiEl&&aiEl.textContent==='') aiEl.textContent='æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
    }

    form.onsubmit=e=>{e.preventDefault();send();};
    input.onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}};

    /* ================= åˆå§‹åŒ– ================= */
    renderList();
    if(activeId) selectChat(activeId);
</script>
</body>
</html>