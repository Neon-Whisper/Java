<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>知识库文件上传</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义滚动条 */
        .custom-scroll::-webkit-scrollbar{width:6px;}
        .custom-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}
        /* 文件项进入动画 */
        @keyframes pop{0%{transform:scale(.9);opacity:0}100%{transform:scale(1);opacity:1}}
        .file-item{animation:pop .3s ease}
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-white min-h-screen flex items-center justify-center p-4">

<form id="uploadForm"
      class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 space-y-5"
      enctype="multipart/form-data">

    <!-- 标题 -->
    <h1 class="text-2xl font-bold text-gray-800 flex items-center space-x-2">
        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span>知识库文件上传</span>
    </h1>

    <!-- 知识库名称 -->
    <div>
        <label for="ragTag" class="block text-sm font-medium text-gray-700 mb-1">知识库名称</label>
        <input id="ragTag" name="ragTag" type="text" required placeholder="例如：客服手册"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
    </div>

    <!-- 文件选择 -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">选择文件</label>
        <div class="flex items-center justify-center w-full">
            <label for="files"
                   class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="mt-2 text-sm text-gray-500">支持 .md / .txt / .sql 文件</p>
                <input id="files" name="files" type="file" multiple accept=".md,.txt,.sql" class="hidden">
            </label>
        </div>
    </div>

    <!-- 文件列表 -->
    <ul id="fileList" class="max-h-48 overflow-y-auto custom-scroll space-y-2"></ul>

    <!-- 按钮 -->
    <button id="submitBtn" type="submit"
            class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <span>开始上传</span>
    </button>

    <!-- 进度条 -->
    <div id="progressBox" class="hidden">
        <div class="flex justify-between text-xs text-gray-600 mb-1">
            <span>上传进度</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
        </div>
    </div>

    <!-- 结果提示 -->
    <p id="resultTip" class="text-center text-sm hidden"></p>
</form>

<script>
    const form   = document.getElementById('uploadForm');
    const fileIn = document.getElementById('files');
    const list   = document.getElementById('fileList');
    const btn    = document.getElementById('submitBtn');
    const progBox= document.getElementById('progressBox');
    const progBar= document.getElementById('progressBar');
    const progTxt= document.getElementById('progressPercent');
    const tip    = document.getElementById('resultTip');

    let fileArr = [];

    fileIn.onchange = () => {
        fileArr = [...fileIn.files].filter(f=>/\.(md|txt|sql)$/i.test(f.name));
        renderList();
    };

    function renderList(){
        list.innerHTML = '';
        fileArr.forEach((f,i)=>{
            const li = document.createElement('li');
            li.className = 'file-item flex items-center justify-between px-3 py-2 bg-gray-50 rounded-lg';
            li.innerHTML = `
      <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-700">${f.name}</span>
        <span class="text-xs text-gray-400">${(f.size/1024).toFixed(1)} KB</span>
      </div>
      <button type="button" class="text-red-500 hover:underline text-sm" data-idx="${i}">移除</button>`;
            list.appendChild(li);
        });
        list.onclick = e=>{
            if(e.target.dataset.idx!=null){
                fileArr.splice(e.target.dataset.idx,1);
                renderList();
            }
        };
    }

    form.onsubmit = async (e) => {
        e.preventDefault();
        if(!fileArr.length) return alert('请选择文件');
        btn.disabled = true;
        progBox.classList.remove('hidden');
        tip.classList.add('hidden');

        const fd = new FormData();
        fd.append('ragTag', form.ragTag.value.trim());
        fileArr.forEach(f=>fd.append('files',f));

        const xhr = new XMLHttpRequest();
        xhr.open('POST','http://localhost:8090/api/v1/rag/upload'); // 替换为实际接口
        xhr.upload.onprogress = (e)=>{
            const p = Math.round(e.loaded/e.total*100);
            progBar.style.width = p+'%';
            progTxt.textContent = p+'%';
        };
        xhr.onload = ()=>{
            btn.disabled = false;
            if(xhr.status===200){
                tip.textContent='上传成功！'; tip.className='text-center text-sm text-green-600';
                form.reset(); fileArr=[]; renderList();
            }else{
                tip.textContent='上传失败：'+xhr.statusText; tip.className='text-center text-sm text-red-600';
            }
        };
        xhr.onerror=()=>{
            btn.disabled=false;
            tip.textContent='网络错误'; tip.className='text-center text-sm text-red-600';
        };
        xhr.send(fd);
    };
</script>
</body>
</html>